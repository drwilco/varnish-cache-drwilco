varnishtest "Drop graced object when new object arrives"

server s1 {
	rxreq 
	txresp -hdr "Vary: X-Foo" -hdr "Cache-Control: max-age=1" -body "1"
	rxreq 
	txresp -hdr "Vary: X-Foo" -hdr "Cache-Control: max-age=1" -body "12"
	rxreq 
	txresp -hdr "Vary: X-Foo" -hdr "Cache-Control: max-age=1" -body "123"
} -start

varnish v1 -vcl+backend {
	sub vcl_recv {
		set req.grace = 0s;
	}
	sub vcl_fetch {
		set beresp.grace = 3600s;
	}
} -start

varnish v1 -expect n_object == 0
varnish v1 -expect sess_conn == 0
varnish v1 -expect client_req == 0
varnish v1 -expect cache_miss == 0
varnish v1 -expect cache_hit == 0
varnish v1 -expect s_sess == 0
varnish v1 -expect s_req == 0

client c1 {
	txreq -hdr "X-Foo: bar"
	rxresp
	expect resp.status == 200
	expect resp.bodylen == 1
	txreq -hdr "X-Foo: blargh"
	rxresp
	expect resp.status == 200
	expect resp.bodylen == 2
} -run

delay 1.1

varnish v1 -expect n_object == 2
varnish v1 -expect sess_conn == 1
varnish v1 -expect client_req == 2
varnish v1 -expect cache_miss == 2
varnish v1 -expect cache_hit == 0
varnish v1 -expect s_sess == 1
varnish v1 -expect s_req == 2

client c1 {
	txreq -hdr "X-Foo: bar"
	rxresp
	expect resp.status == 200
	expect resp.bodylen == 3
} -run

varnish v1 -expect n_object == 2
varnish v1 -expect sess_conn == 2
varnish v1 -expect client_req == 3
varnish v1 -expect cache_miss == 3
varnish v1 -expect cache_hit == 0
varnish v1 -expect s_sess == 2
varnish v1 -expect s_req == 3

server s1 -wait

delay 1.1

client c1 {
	txreq -hdr "X-Foo: bar"
	rxresp
	expect resp.status == 503
} -run

varnish v1 -expect n_object == 2
varnish v1 -expect sess_conn == 3
varnish v1 -expect client_req == 4
varnish v1 -expect cache_miss == 4
varnish v1 -expect cache_hit == 0
varnish v1 -expect s_sess == 3
varnish v1 -expect s_req == 4

varnish v1 -vcl {
	backend default {
		.host = "${s1_addr}";
		.port = "${s1_port}";
		.max_connections = 1;
		.probe = {
			.url = "/";
			.timeout = 1s;
			.interval = 1000s;
			.window = 1;
			.threshold = 1;
			.initial = 0;
		}
	}

	sub vcl_recv {
		set req.grace = 3600s;
	}
}

delay 0.1

client c1 {
	txreq -hdr "X-Foo: bar"
	rxresp
	expect resp.status == 200
	expect resp.bodylen == 3
	txreq -hdr "X-Foo: blargh"
	rxresp
	expect resp.status == 200
	expect resp.bodylen == 2
} -run

varnish v1 -expect n_object == 2
varnish v1 -expect sess_conn == 4
varnish v1 -expect client_req == 6
varnish v1 -expect cache_miss == 4
varnish v1 -expect cache_hit == 2
varnish v1 -expect s_sess == 4
varnish v1 -expect s_req == 6
